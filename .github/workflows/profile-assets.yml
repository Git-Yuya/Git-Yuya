name: Update Profile Assets

on:
  schedule:
    - cron: '10 19 * * *'  # 04:10 (JST) == 19:10 (UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    name: download-profile-assets
    steps:
      - uses: actions/checkout@v6

      - name: Download Images with Validation
        run: |
          # --- 共通設定 ---
          DEST_DIR="profile-assets"
          USERNAME="Git-Yuya"
          STATS_BASE="https://github-readme-stats-six-sepia-36.vercel.app"
          THEME="theme=default&title_color=ffffff&text_color=ffffff&icon_color=ffffff&bg_color=35,473B7B,3584A7,30D2BE"
          mkdir -p "$DEST_DIR"

          # --- 関数定義: SVG検証付きダウンロード ---
          download_svg() {
            local url="$1" filename="$2"
            local dest="$DEST_DIR/$filename"
            local temp
            temp=$(mktemp)

            curl -sL "$url" -o "$temp"

            if grep -q "<svg" "$temp"; then
              mv "$temp" "$dest"
              echo "✅ [OK] $dest"
            else
              echo "⚠️ [SKIP] Invalid SVG: $url"
              rm -f "$temp"
            fi
          }

          # --- 1. Typograssy ---
          download_svg "https://typograssy.deno.dev/api?text=Welcome%20to%20my%20profile!%20&l0=002642&l1=0077cc&l2=44aaff&l3=88ccff&l4=bbddff&bg=000000&frame=ffffff&speed=100&comment=" "typograssy.svg"

          # --- 2. Skills ---
          download_svg "https://skillicons.dev/icons?theme=dark&perline=12&i=py,pytorch,sklearn,tensorflow,django,flask,fastapi,opencv,qt,matlab,c,cpp,js,ts,threejs,react,vite,vercel,html,css,bootstrap,tailwind,latex,md,sqlite,postgres,mysql,aws,azure,gcp,windows,linux,docker,git,github,githubactions" "skills.svg"

          # --- 3. Stats & Langs & Trophy ---
          download_svg "$STATS_BASE/api?username=$USERNAME&locale=en&show_icons=true&rank_icon=github&include_all_commits=false&show=reviews,discussions_started,discussions_answered,prs_merged&number_format=long&$THEME&ring_color=ffffff&border_radius=10&line_height=25&card_width=420" "github-stats.svg"
          download_svg "$STATS_BASE/api/top-langs/?username=$USERNAME&locale=en&show_icons=true&size_weight=0.5&count_weight=0.5&langs_count=20&layout=compact&$THEME&border_radius=10&card_width=330" "top-langs.svg"
          download_svg "https://trophygh.kolioaris.xyz/?username=$USERNAME&theme=algolia&no-bg=false&no-frame=false&column=5&row=2&margin-w=5&margin-h=5" "trophy.svg"

          # --- 4. Repo Pins ---
          PIN_BASE="$STATS_BASE/api/pin/?$THEME"

          REPOS=(
            Git-Yuya.github.io
            atcoder
            cs50-intro-to-cs
            gci
            dl-lecture-competition
            lecture-ai-engineering
            simplechat
            lecture-survey-dashboard
            rag-chatbot
            tokyo-2020-olympics-aquatics
            swimming-comp-score-calculation
            walking-time-prediction
            pedestrian-travel-time
            scramble-crossing-simulation
            ubiquitous-projection
            parallel-processing
          )
          for repo in "${REPOS[@]}"; do
            download_svg "$PIN_BASE&username=$USERNAME&repo=$repo" "pin-$repo.svg"
          done

          MATSUOLAB_REPOS=(
            AIE-DXproject_1_front
            AIE-DXproject_1_back
          )
          for repo in "${MATSUOLAB_REPOS[@]}"; do
            download_svg "$PIN_BASE&username=matsuolab&repo=$repo" "pin-$repo.svg"
          done

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add profile-assets/*.svg

          if ! git diff --cached --quiet; then
            git commit -m "Update profile assets"
            git push
          else
            echo "No changes to commit."
          fi
